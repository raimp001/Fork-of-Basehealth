// ============================================================================
// Prisma Schema for BaseHealth.xyz
// Compatible with PostgreSQL (Neon)
// ============================================================================
//
// HIPAA COMPLIANCE NOTES:
// -----------------------
// This schema stores Protected Health Information (PHI) as defined by HIPAA.
// 
// REQUIREMENTS FOR HIPAA COMPLIANCE:
// 1. Database provider (Neon) MUST have a signed Business Associate Agreement (BAA)
// 2. All connections MUST use SSL/TLS encryption (sslmode=require in connection string)
// 3. Field-level encryption is available via lib/hipaa/encryption.ts
// 4. All PHI access MUST be logged via lib/hipaa/phi-access-log.ts
// 5. Audit logs MUST be retained for 6 years minimum
//
// PHI FIELDS ARE MARKED WITH: /// @phi - [CATEGORY]
// Categories follow HIPAA Safe Harbor 18 identifiers
//
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // IMPORTANT: Ensure DATABASE_URL includes sslmode=require for HIPAA compliance
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================
// HIPAA NOTE: User records may contain PHI when associated with healthcare data

model User {
  id        String   @id @default(cuid())
  /// @phi - EMAIL (electronic identifiers)
  email     String   @unique
  password  String? // Nullable for OAuth users - NEVER log this field
  /// @phi - NAME (individual identifiers)
  name      String?
  role      UserRole @default(PATIENT)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  patient   Patient?
  caregiver Caregiver?
  provider  Provider?
  bookings  Booking[]
  auditLogs AuditLog[]
  
  @@index([email])
  @@map("users")
}

enum UserRole {
  PATIENT
  CAREGIVER
  PROVIDER
  ADMIN
}

// ============================================================================
// PATIENT
// ============================================================================
// HIPAA NOTE: This model contains extensive PHI. All access must be logged.
// Use lib/hipaa utilities for encryption and access logging.

model Patient {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Info - PHI Fields
  /// @phi - DATE (dates related to individual)
  dateOfBirth   DateTime?
  /// @phi - PHONE (telephone numbers)
  phone         String?
  /// @phi - GEOGRAPHIC (address smaller than state)
  address       String?
  /// @phi - NAME, PHONE (contact information)
  emergencyContact String?
  
  // Medical Info - PHI Fields (health information)
  /// @phi - HEALTH_INFO (medical data)
  bloodType     String?
  /// @phi - HEALTH_INFO (medical conditions - highly sensitive)
  allergies     String[]
  /// @phi - HEALTH_INFO (medical conditions - highly sensitive)
  conditions    String[]
  /// @phi - HEALTH_INFO (medication list - highly sensitive)
  medications   String[]
  
  // Relations
  bookings      Booking[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("patients")
}

// ============================================================================
// ONBOARDING APPLICATION (Unified for Provider & Caregiver)
// ============================================================================
// HIPAA NOTE: Contains PHI for healthcare provider credentialing

model Application {
  id              String            @id @default(cuid())
  
  // Role & Region
  role            ApplicationRole
  country         String            @default("US")
  regions         String[]          // States/provinces where they'll practice
  
  // Applicant Info - PHI Fields
  /// @phi - EMAIL (electronic identifiers)
  email           String
  /// @phi - PHONE (telephone numbers)
  phone           String?
  /// @phi - NAME (individual identifiers)
  firstName       String?
  /// @phi - NAME (individual identifiers)
  lastName        String?
  /// @phi - NAME (individual identifiers)
  fullName        String?
  organizationName String?
  
  // Step Completion Tracking
  currentStep     Int               @default(0)
  stepsCompleted  Json              @default("{}") // { "0": true, "1": true, ... }
  
  // Application Status
  status          ApplicationStatus @default(DRAFT)
  submittedAt     DateTime?
  
  // Review Info
  reviewedAt      DateTime?
  reviewedBy      String?
  reviewNotes     String?           @db.Text
  approvalScope   Json?             // { states: [], services: [] }
  
  // Provider-Specific Fields
  providerType    ProviderType?
  professionType  String?           // MD, DO, NP, PA, RN, PharmD, etc.
  specialty       String?
  taxonomyCode    String?
  
  // NPI Info (for US Providers)
  /// @phi - LICENSE_NUMBER (professional identifiers)
  npiNumber       String?
  npiVerified     Boolean           @default(false)
  npiData         Json?             // Cached NPPES data
  
  // License Info
  /// @phi - LICENSE_NUMBER (certificate/license numbers)
  licenseNumber   String?
  licenseState    String?
  licenseExpiry   DateTime?
  licenseVerified Boolean           @default(false)
  
  // DEA (optional, for prescribing)
  /// @phi - LICENSE_NUMBER (DEA registration - highly sensitive)
  deaNumber       String?
  deaExpiry       DateTime?
  
  // Malpractice Insurance (optional)
  malpracticeCarrier String?
  malpracticePolicyNumber String?
  malpracticeExpiry DateTime?
  
  // Caregiver-Specific Fields
  servicesOffered String[]          // Companionship, ADLs, transport, etc.
  experienceYears Int?
  bio             String?           @db.Text
  availability    Json?             // { days: [], times: [] }
  hasTransport    Boolean           @default(false)
  
  // Identity (for background check)
  /// @phi - DATE (dates related to individual)
  dateOfBirth     DateTime?
  
  // Certifications (caregiver)
  certifications  String[]          // CNA, HHA, BLS, CPR, etc.
  languages       String[]
  
  // Attestations
  attestedAccuracy Boolean          @default(false)
  attestedLicenseScope Boolean      @default(false)
  consentToVerification Boolean     @default(false)
  consentToBackgroundCheck Boolean  @default(false)
  attestedAt      DateTime?
  
  // Relations
  documents       Document[]
  verifications   Verification[]
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([role, country])
  @@map("applications")
}

enum ApplicationRole {
  PROVIDER
  CAREGIVER
}

enum ApplicationStatus {
  DRAFT           // Incomplete, can resume
  SUBMITTED       // Awaiting review
  UNDER_REVIEW    // Admin is reviewing
  PENDING_INFO    // Additional info requested
  APPROVED        // Approved to practice
  REJECTED        // Rejected
  SUSPENDED       // Temporarily suspended
}

// ============================================================================
// DOCUMENT STORAGE
// ============================================================================

model Document {
  id            String        @id @default(cuid())
  applicationId String
  application   Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Document Info
  type          DocumentType
  fileName      String
  fileUrl       String        // S3/Storage URL
  fileSize      Int?
  mimeType      String?
  
  // Verification
  verified      Boolean       @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  verificationNotes String?
  
  // Expiry tracking
  expiresAt     DateTime?
  
  // Timestamps
  uploadedAt    DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([applicationId])
  @@index([type])
  @@map("documents")
}

enum DocumentType {
  LICENSE
  NPI_PROOF
  DEA_CERTIFICATE
  MALPRACTICE_COI
  BOARD_CERTIFICATION
  GOVERNMENT_ID
  BACKGROUND_CHECK
  CPR_CERTIFICATION
  OTHER
}

// ============================================================================
// VERIFICATION RESULTS
// ============================================================================

model Verification {
  id            String            @id @default(cuid())
  applicationId String
  application   Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Verification Type
  type          VerificationType
  
  // Status
  status        VerificationStatus @default(PENDING)
  
  // Results
  passed        Boolean?
  matchScore    Float?            // For fuzzy name matching
  rawResponse   Json?             // Redacted API response
  errorMessage  String?
  
  // Timestamps
  checkedAt     DateTime          @default(now())
  expiresAt     DateTime?         // When re-check is needed
  
  @@index([applicationId])
  @@index([type, status])
  @@map("verifications")
}

enum VerificationType {
  NPI_LOOKUP
  LICENSE_CHECK
  OIG_LEIE
  SAM_EXCLUSION
  BACKGROUND_CHECK
  DEA_VERIFICATION
  BOARD_CERTIFICATION
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  ERROR
  EXPIRED
}

// ============================================================================
// AUDIT LOGS
// ============================================================================

model AuditLog {
  id          String    @id @default(cuid())
  
  // Actor
  actorId     String?
  actor       User?     @relation(fields: [actorId], references: [id], onDelete: SetNull)
  actorEmail  String?   // Preserve even if user deleted
  actorRole   String?
  
  // Action
  action      String    // e.g., "application.submitted", "admin.approved"
  entityType  String    // e.g., "Application", "Provider"
  entityId    String?
  
  // Details
  description String?   @db.Text
  metadata    Json?     // Additional context
  ipAddress   String?
  userAgent   String?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// ONBOARDING REQUIREMENTS (Rules Engine)
// ============================================================================

model OnboardingRequirement {
  id          String    @id @default(cuid())
  
  // Scope
  role        ApplicationRole
  country     String    // ISO country code or "*" for all
  region      String?   // State/province code or null for country-wide
  
  // Field/Check
  fieldName   String    // e.g., "npiNumber", "licenseNumber", "oig_check"
  
  // Requirements
  required    Boolean   @default(false)
  recommended Boolean   @default(false)
  
  // Conditional Logic
  condition   Json?     // e.g., { "professionType": ["MD", "DO"] }
  
  // Display
  label       String
  helpText    String?
  order       Int       @default(0)
  
  // Admin config
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([role, country, region, fieldName])
  @@index([role, country])
  @@map("onboarding_requirements")
}

// ============================================================================
// CAREGIVER MODEL (Following system prompt requirements)
// ============================================================================
// HIPAA NOTE: Contains caregiver PHI - requires access logging

model Caregiver {
  id          String           @id @default(cuid())
  userId      String?          @unique
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Application reference
  applicationId String?        @unique
  
  // Personal Information - PHI Fields
  /// @phi - NAME (individual identifiers)
  firstName   String
  /// @phi - NAME (individual identifiers)
  lastName    String
  /// @phi - EMAIL (electronic identifiers)
  email       String           @unique
  /// @phi - PHONE (telephone numbers)
  phone       String?
  
  // Professional Information
  /// @phi - LICENSE_NUMBER (professional license)
  licenseNumber       String?
  licenseType         String?
  specialties         String[]         // Array of specialties
  yearsExperience     String?
  education           String?
  certifications      String[]         // Additional certifications
  
  // Service Information
  location            String?
  serviceAreas        String[]         // Areas they serve
  languagesSpoken     String[]
  acceptInsurance     Boolean          @default(false)
  willingToTravel     Boolean          @default(false)
  availableForUrgent  Boolean          @default(false)
  hourlyRate          Decimal?         @db.Decimal(10, 2)
  
  // Status & Verification (CRITICAL for filtering)
  status              CaregiverStatus  @default(PENDING)
  isMock              Boolean          @default(false)  // Flag mock/test data
  verified            Boolean          @default(false)  // Verified caregiver
  isLicensed          Boolean          @default(false)
  isCPRCertified      Boolean          @default(false)
  isBackgroundChecked Boolean          @default(false)
  
  // Ratings & Reviews
  rating              Decimal?         @default(0) @db.Decimal(3, 2)
  reviewCount         Int              @default(0)
  
  // Additional
  bio                 String?          @db.Text
  carePhilosophy      String?          @db.Text
  digitalWalletAddress String?
  
  // Application metadata
  applicationStatus   String?          // 'pending', 'approved', 'rejected'
  submittedAt         DateTime?
  reviewedAt          DateTime?
  reviewedBy          String?
  reviewNotes         String?
  
  // Timestamps
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  lastActiveDate      DateTime         @default(now())
  
  // Relations
  bookings            Booking[]
  
  @@index([status, verified, isMock])
  @@index([email])
  @@index([location])
  @@map("caregivers")
}

enum CaregiverStatus {
  AVAILABLE
  UNAVAILABLE
  PENDING
  SUSPENDED
  INACTIVE
}

// ============================================================================
// PROVIDER (Healthcare Providers - Physicians and Health Apps)
// ============================================================================

model Provider {
  id          String   @id @default(cuid())
  userId      String?  @unique
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Application reference
  applicationId String? @unique
  
  // Provider Type: PHYSICIAN or APP
  type        ProviderType @default(PHYSICIAN)
  
  // For Physicians
  fullName    String?  // For physicians: "Dr. John Smith"
  // For Apps/Clinics
  organizationName String? // For apps: "HealthApp Inc."
  
  email       String   @unique
  passwordHash String? // Hashed password (nullable for OAuth)
  phone       String?
  
  // Professional Information (for physicians)
  npiNumber   String?  @unique // NPI for physicians (nullable for apps)
  licenseNumber String? // State medical board license number (required for physicians)
  licenseState String?
  licenseExpiry DateTime?
  specialties String[] // Array of specialties
  professionType String? // MD, DO, NP, PA, RN, PharmD
  taxonomyCode String?
  bio         String?  @db.Text
  
  // Multi-state licensing
  statesOfPractice String[] // States where they're licensed to practice
  
  // Location
  location    String?
  country     String   @default("US")
  
  // Status
  status      ProviderStatus @default(PENDING)
  acceptingPatients Boolean @default(true)
  isVerified  Boolean  @default(false)
  
  // Exclusions Screening
  lastOigCheck DateTime?
  oigClear    Boolean?
  lastSamCheck DateTime?
  samClear    Boolean?
  
  rating      Decimal? @default(0) @db.Decimal(3, 2)
  reviewCount Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([npiNumber])
  @@index([email])
  @@index([type])
  @@index([status])
  @@map("providers")
}

enum ProviderType {
  PHYSICIAN
  APP
}

enum ProviderStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

// ============================================================================
// BOOKING MODEL (For Caregiver Bookings with Payment Integration)
// ============================================================================

model Booking {
  id          String        @id @default(cuid())
  
  // Relations
  patientId   String
  patient     Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  caregiverId String
  caregiver   Caregiver     @relation(fields: [caregiverId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Booking Details
  startDate   DateTime
  endDate     DateTime?
  duration    String?       // "1-2 weeks", "1 month", etc.
  frequency   String?       // "Daily", "Weekly", etc.
  careType    String?       // "Elder Care", "Post-Surgery", etc.
  urgency     String?       // "Immediate", "Standard", etc.
  
  // Requirements
  requirements Json?        // Store requirements as JSON
  specialNeeds String?
  notes       String?       @db.Text
  
  // Payment Information
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("USD")
  
  // Coinbase Commerce Integration
  paymentProvider  PaymentProvider?
  paymentProviderId String?    // Coinbase Commerce charge ID or transaction hash
  checkoutUrl      String?     // Coinbase Commerce hosted checkout URL
  paymentMetadata  Json?       // Store additional payment data
  
  // Booking Status
  status      BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  paidAt      DateTime?
  confirmedAt DateTime?
  completedAt DateTime?
  cancelledAt DateTime?
  
  @@index([patientId])
  @@index([caregiverId])
  @@index([status])
  @@index([paymentStatus])
  @@index([paymentProviderId])
  @@map("bookings")
}

enum BookingStatus {
  PENDING       // Initial state
  CONFIRMED     // After payment confirmed
  IN_PROGRESS   // Care is being provided
  COMPLETED     // Care completed
  CANCELLED     // Booking cancelled
  REFUNDED      // Payment refunded
}

enum PaymentStatus {
  PENDING       // Awaiting payment
  PROCESSING    // Payment in progress
  PAID          // Payment confirmed
  FAILED        // Payment failed
  REFUNDED      // Payment refunded
  EXPIRED       // Payment window expired
}

enum PaymentProvider {
  COINBASE_COMMERCE  // Coinbase Commerce checkout
  COINBASE_ONCHAIN   // Direct onchain payment
  BASE_USDC          // Base blockchain USDC
  BASE_ETH           // Base blockchain ETH
  STRIPE             // Traditional payment
}

// ============================================================================
// TRANSACTION LOG (For payment audit trail)
// ============================================================================

model Transaction {
  id              String          @id @default(cuid())
  bookingId       String?
  
  // Transaction Details
  transactionHash String?         @unique // Blockchain transaction hash
  provider        PaymentProvider
  providerId      String?         // External provider ID
  
  // Amounts
  amount          Decimal         @db.Decimal(10, 2)
  currency        String
  fee             Decimal?        @db.Decimal(10, 2)
  netAmount       Decimal?        @db.Decimal(10, 2)
  
  // Status
  status          PaymentStatus   @default(PENDING)
  
  // Metadata
  metadata        Json?
  webhookData     Json?
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  completedAt     DateTime?
  
  @@index([transactionHash])
  @@index([bookingId])
  @@index([status])
  @@map("transactions")
}

// ============================================================================
// WEBHOOK EVENTS (For Coinbase Commerce webhooks)
// ============================================================================

model WebhookEvent {
  id          String   @id @default(cuid())
  
  // Webhook Details
  provider    String   // 'coinbase_commerce', 'stripe', etc.
  eventType   String   // 'charge:confirmed', 'charge:failed', etc.
  eventId     String?  @unique // External event ID
  
  // Payload
  payload     Json     // Full webhook payload
  signature   String?  // Webhook signature for verification
  
  // Processing
  processed   Boolean  @default(false)
  processedAt DateTime?
  error       String?  @db.Text
  
  // Associated Booking
  bookingId   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventId])
  @@index([processed])
  @@index([bookingId])
  @@map("webhook_events")
}
